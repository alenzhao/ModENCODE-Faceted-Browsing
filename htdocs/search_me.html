<html>
 <head>
    <title>Faceted Search of modENCODE Data Sets</title>
  
    <link href="modencode.js" type="application/json" rel="exhibit/data" />
    <link rel='stylesheet' href='http://www.simile-widgets.org/styles/common.css' type='text/css' />
    <script src="http://api.simile-widgets.org/exhibit/2.2.0/exhibit-api.js"
            type="text/javascript"></script>

    <script src="prototype.js"
            type="text/javascript"></script>

    <script type="text/javascript">
      var SelectedItems = new Hash();

      function clear_all () {
         SelectedItems = new Hash();
         hilight_items();
         $('selection_count').innerHTML   = 'No tracks selected';
      }

      function toggle_track (checkbox,turn_on) {
       var container = checkbox.ancestors().find(
            function(el) { return el.hasClassName('submission')});

       var id = container.getAttribute('ex:itemid');

       if (turn_on == null)
          turn_on = !container.hasClassName('selected');

       if (turn_on) {
          container.addClassName('selected');
          SelectedItems.set(id,1);
       } else {
          container.removeClassName('selected');
          SelectedItems.unset(id);
       }

      var selected = SelectedItems.keys();
      if (selected.size() > 0) {
        var url     = format_url();
        var sources = url.keys();
        $('selection_count').innerHTML   = selected.size()+' tracks selected';
        $('selection_count').innerHTML  += ' [<a href="javascript:clear_all()">clear</a>].';
        $('selection_count').innerHTML += '<br/>Browse ';
        if (url.keys().size() > 0) {
          url.keys().each(function (e) { 
              var u = url.get(e);
              $('selection_count').innerHTML += '<a target="_new" href="' + u + '">'+e+' tracks</a> ';
          });
       } else {
          $('selection_count').innerHTML += '<i>invalid track</i>';
       }
        $('selection_count').innerHTML += '.<br/><a href="foobar">Download</a> selected data.';
      } else {
        $('selection_count').innerHTML='No tracks selected';
      }
     }

      function hilight_items () {
          var divs = $$('.submission');
          divs.each (function (d) {
              var id = d.getAttribute('ex:itemid');
              if (SelectedItems.get(id)) {
                     d.addClassName('selected');
                     d.select('input')[0].checked=1;
              } else {
                     d.removeClassName('selected');
                     d.select('input')[0].checked=0;
              }
          });
      }

      function format_url() {
        var selected = $$('.selected.submission');

        // consolidate sources, tracks and subtracks
        var tra    = new Hash();
        for (var i=0;i<selected.size();i++) {
           var tracks = window.database.getObjects(selected[i].getAttribute('ex:itemid'),'Tracks').toArray();
           tracks.each(function (e) {
		var fields = e.split('/');
		var source    = fields[0];
                var track     = fields[1];
                var subtrack  = fields[2];
		if (subtrack == null) subtrack = '';
		if (tra.get(source) == null )            tra.set(source,new Hash());
		if (tra.get(source).get(track) == null)  tra.get(source).set(track, new Hash());
		tra.get(source).get(track).set(subtrack,1);
              });
        }
        var url = new Hash();
        tra.keys().each(function (s) {
             var source = s;
             var tracks = tra.get(s);
             if (url.get(source)==null)
	        url.set(source,'http://modencode.oicr.on.ca/fgb2/gbrowse/'+source+'/?l=Genes');
             var v = url.get(source);
             tracks.keys().each(function (t) {
	        var subtracks = tracks.get(t).keys();
                v += ";l="+t;
		if (subtracks[0] != '')
                   v += '/' + subtracks.join('+');
             });
	     url.set(source,v);
	});
	return url;
      }
    </script>

    <style>
      body {
        font-family: sans-serif;
        font-size: 10pt;
      }
      td {
      font-size: 10pt
      }
      .indent {
       position:relative;
       left: 10em;
      }
      div.submission {
      float:      left;
      width:      280px;
      height:     150px;
      border:     1px solid #BCB79E;
      background: #F0FFF0;
      padding:    1em;
      margin:     0.5em;
      text-align: left;
      overflow: auto;
      }

      div.status {
       font-weight:bold;
       text-align:center;
      border:     1px solid #BCB79E;
      background: #F0FFF0;
      }
        span.exhibit-collectionView-group-count {
            color:       #ccc;
            font-weight: normal;
        }
        div.exhibit-facet-value-selected {
            background:  none;
            font-weight: bold;
        }

       div.name {
           font-weight: bold;
           font-size:   110%;
       }
      .submission {
           border:     1px solid #ddd;
           font-size: 9pt;
       }
      .organism {
           font-style: italic;
       }
      .condition {
      }
      .field-label {
        font-weight: bold;
        color: grey;
      }
      div.selected {
        background-color: wheat;
      }
      div.select-track {
        font-size: 110%;
        font-weight: bold;
        color: blue;
        float: right;  
      }
    </style>
 </head> 

    <h1>Faceted Search of modENCODE Data Sets</h1>

    <table width="100%">
      <tr valign="top">
	<td id="left-column" width="20%">
	  Search: <span ex:role="facet" ex:facetClass="TextSearch"></span>
	  <div  ex:role="facet" ex:expression=".organism"  ex:height="8em" ex:facetLabel="Organism"></div>
	  <div  ex:role="facet" ex:expression=".technique" ex:height="8em" ex:facetLabel="Technique"></div>
	  <div  ex:role="facet" ex:expression=".target"    ex:height="8em" ex:facetLabel="Target Type"></div>
	  <div  ex:role="facet" ex:expression=".factor"    ex:height="8em" ex:facetLabel="Factor"></div>
	</td>

	<td id="middle-column" width="60%">
	  <div class="status" id="selection_count">no tracks selected</div>
	  <div ex:role="view" ex:viewClass="Thumbnail" id="filter_results"></div>
	  <div ex:role="lens" ex:onshow="hilight_items()" class="submission" style="display:none">
	    <div class="select-track">
	      <div>
		<label>
		  <input type="checkbox" ex:onClick-subcontent="toggle_track(this)"/>Select track
		</label>
	      </div>
	    </div>
	    <div class="name">
	      <span  ex:content=".technique" class="field-label"></span>:<br>
	      <span  ex:content=".label"></span>
	    </div>
	    <div>
	      <span class="field-label">Biological Source:</span>
	      <span class="organism">
		<span ex:content=".organism"></span>
		<span ex:content=".Strain"></span>
	      </span>
	    </div>
	    <div class="experiment">
	      <span class="field-label">Experiment type:</span>
	      <span ex:if-exists=".technique">
		<span ex:content=".technique"></span>
	      </span>
	      <span ex:if-exists=".target">
		<span ex:content=".target"></span>
	      </span>
	    </div>
	    <div ex:if-exists=".factor">
	      <span class="field-label">Factor:</span>	
	      <span ex:content=".factor" style="font-weight:bold"></span>
	    </div>
	    <div class="condition">
	      <span class="field-label">Conditions:</span>
	      <span ex:if-exists=".Developmental-Stage">
		<span ex:content=".Developmental-Stage"></span>
	      </span>
	      <span ex:if-exists=".temperature">
		<span ex:content=".temperature"></span>
	      </span>
	      <span ex:if-exists=".Compound">
		<span ex:content=".Compound"></span> salt
	      </span>
	    </div>
	  </div>
	</td>
	
	<td id="right-column" width="20%">
	  <div  ex:role="facet" ex:expression=".Developmental-Stage" ex:height="8em" ex:facetLabel="Developmental Stage"></div>
	  <div  ex:role="facet" ex:expression=".Strain"              ex:height="8em" ex:facetLabel="Strain"></div> 
	  <div  ex:role="facet" ex:expression=".Cell-Line"           ex:height="8em" ex:facetLabel="Cell Line"></div>
	  <div  ex:role="facet" ex:expression=".Tissue"              ex:height="8em" ex:facetLabel="Tissue"></div>
	  <div  ex:role="facet" ex:expression=".temperature"         ex:height="8em" ex:facetLabel="Temperature"></div>
	</td>
      </tr>
    </table>
<!--    
    <div ex:role="facet" 
	 ex:facetClass="Cloud"
	 ex:expression=".technique" 
    </div>
    <div ex:role="facet" 
	 ex:facetClass="Cloud"
	 ex:expression=".Developmental-Stage" 
     </div>
    <div ex:role="facet" 
	 ex:facetClass="Cloud"
	 ex:expression=".Cell-Line" 
     </div>
-->


 </body>
 </html>
